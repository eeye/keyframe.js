<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <title>
        Velocity Test
    </title>
    <style>
        .container {
            width: 500px;
        }

        .dummy {
            display: block;
            position: relative;
            left: 0;
            opacity: 0.65;
            filter: alpha(opacity=65);
            width: 15px;
            height: 15px;
            margin-bottom: 3px;
            border-radius: 15px;
            background-color: #3a3a3a;
            /* 
            transform: translateZ(0); */
        }

        #stop {
            display: none;
        }
    </style>
    <script src="https://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
        crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/velocity/1.5.1/velocity.min.js"></script>
    <script src="../keyframe.js"></script>
</head>

<body>
    <select id="mode">
        <option>KeyframeJS</option>
        <option>Velocity</option>
        <option>jQuery</option>
    </select>
    <select id="bubbles">
        <option>100</option>
        <option>250</option>
        <option>500</option>
        <option>1000</option>
    </select>
    <button id="start">Start</button>
    <button id="stop">Stop</button>
    <div class="container">
    </div>

    <script>
        var keyframe;
        var run = false;


        $('#start').click(function () {
            $(this).hide();
            $('#stop').show();
            for (var i = 0; i < $('#bubbles').val(); i++) {
                $('.container').append('<div class="dummy"></div>')
            }
            switch ($('#mode').val()) {
                case 'KeyframeJS':
                    startKeyframeJS();
                    break;
                case 'jQuery':
                    startjQuery();
                    break;
                case 'Velocity':
                    startVelocity();
                    break;
            }
        })

        $('#stop').click(function () {
            $(this).hide();
            $('#start').show();
            switch ($('#mode').val()) {
                case 'KeyframeJS':
                    stopKeyframeJS();
                    break;
                case 'jQuery':
                    stopjQuery();
                    break;
                case 'Velocity':
                    stopVelocity();
                    break;
            }
            $('.dummy').remove()
        })

        function startKeyframeJS() {
            $('.dummy').each(function () {
                var channels = {}
                var dummy = $(this)

                channels['left'] = {
                    'start_value': 0, 'onUpdate': function (value) {
                        dummy.css('left', value + '%')
                    }, 'keyframes': [[0.95, 85, 'easeInOutQuad']]
                }

                channels['opacity'] = {
                    'start_value': 0.65, 'onUpdate': function (value) {
                        dummy.css('opacity', value)
                    }, 'keyframes': [[0.95, 1, 'easeInOutQuad']]
                }
                keyframe = new KeyframeJS(channels)
                keyframe.start()
            })
        }

        function stopKeyframeJS() {
            keyframe.stop()
        }

        function startjQuery() {
            $('.dummy').each(function () {
                var dummy = $(this)
                var reverse = false;
                run = true;

                var animate = function () {
                    if (!run && !reverse) return;
                    if (reverse) {
                        dummy.animate({ left: '0%', opacity: 0.65 }, 950, "swing", animate)
                    } else {
                        dummy.animate({ left: '85%', opacity: 1 }, 950, "swing", animate)
                    }
                    reverse = !reverse
                }
                animate()
            })
        }

        function stopjQuery() {
            run = false;
        }

        function startVelocity() {
            $('.dummy').each(function () {
                var dummy = $(this)
                var reverse = false;
                run = true;

                var animate = function () {
                    if (!run && !reverse) return;
                    if (reverse) {
                        dummy.velocity({ left: '0%', opacity: 0.65 }, { complete: animate, duration: 950, easing: "ease-in-out" })
                    } else {
                        dummy.velocity({ left: '85%', opacity: 1 }, { complete: animate, duration: 950, easing: "ease-in-out" })
                    }
                    reverse = !reverse
                }
                animate()
            })
        }

        function stopVelocity() {
            run = false;
        }

    </script>
</body>

</html>